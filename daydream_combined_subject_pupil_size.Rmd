---
title: "DeepDream - Subject 2 Physiological Analysis"
author:    |
    | Colin Ayres  
    | c.ayres@student.uw.edu.pl
date: "January 2025"
output: html_document
chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Import Packages

```{r warning=FALSE, message=FALSE}
# Load necessary packages
library(tidyverse)
library(here)
library(ggplot2)
library(zoo)
library(dplyr)
library(patchwork)
library(mgcv)

# Set working directory
mds_dir <- here::here()

```

## Defining Functions to Clean & Combine Data

```{r}
# Splitting Vectors into Directional Components
split_eye_direction <- function(data) {
  data %>%
    mutate(
      # Remove parentheses and split into components
      values = strsplit(gsub("[()]", "", CombinedEyeDirection), ","),
      # Extract numeric values for each dimension
      CombinedEyeDirectionX = sapply(values, function(x) as.numeric(x[1])),
      CombinedEyeDirectionY = sapply(values, function(x) as.numeric(x[2])),
      CombinedEyeDirectionZ = sapply(values, function(x) as.numeric(x[3])),
      # Remove temporary values column
      .keep = "unused"
    )
}

# While blinking, pupil values are recorded as negative. I replace negative values with interpolated values below. For example, (5, -3, -2, -4, 9) will become (5, 6, 7, 8, 9).
# Interpolate blinking values
interpolate_blinking <- function(data) {
  data %>%
    # Replace invalid values with NA
    mutate(
      LeftEyePupilSize = ifelse(LeftEyePupilSize < 0, NA, LeftEyePupilSize),
      RightEyePupilSize = ifelse(RightEyePupilSize < 0, NA, RightEyePupilSize),
      CombinedEyeDirectionX = ifelse(CombinedEyeDirectionX < -0.98, NA, CombinedEyeDirectionX),
      CombinedEyeDirectionY = ifelse(CombinedEyeDirectionY < -0.98, NA, CombinedEyeDirectionY),
      CombinedEyeDirectionZ = ifelse(CombinedEyeDirectionZ < -0.98, NA, CombinedEyeDirectionZ)
    ) %>%
    # Linear interpolation for missing values
    mutate(
      across(c(LeftEyePupilSize, RightEyePupilSize, 
               CombinedEyeDirectionX, CombinedEyeDirectionY, CombinedEyeDirectionZ),
             ~ zoo::na.approx(., na.rm = FALSE))
    ) %>%
    # Fill leading/trailing NAs using last observation carried forward/backward
    mutate(
      LeftEyePupilSize = zoo::na.locf(zoo::na.locf(LeftEyePupilSize, na.rm = FALSE, fromLast = TRUE), na.rm = FALSE),
      RightEyePupilSize = zoo::na.locf(zoo::na.locf(RightEyePupilSize, na.rm = FALSE, fromLast = TRUE), na.rm = FALSE),
      CombinedEyeDirectionX = zoo::na.locf(zoo::na.locf(CombinedEyeDirectionX, na.rm = FALSE, fromLast = TRUE), na.rm = FALSE),
      CombinedEyeDirectionY = zoo::na.locf(zoo::na.locf(CombinedEyeDirectionY, na.rm = FALSE, fromLast = TRUE), na.rm = FALSE),
      CombinedEyeDirectionZ = zoo::na.locf(zoo::na.locf(CombinedEyeDirectionZ, na.rm = FALSE, fromLast = TRUE), na.rm = FALSE)
    )
}

# Getting rid of "Countdown" (It takes 2 seconds and only appears in one of the conditions, messes up legend)
# Also getting rid of values for which Luminosity = 0
clean_phase_luminosity <- function(data) {
  # Perform cleaning operations
  data %>%
    mutate(Phase = ifelse(Phase == "Countdown", "BeforeRecording", Phase)) %>%
    filter(Luminosity != 0)
}

```

## Load and Process All Subject Data

```{r warning=FALSE, message=FALSE}
# Import data
import_subjects <- function(data_dir = "pre-study") {
  # Get list of all device data files
  file_list <- list.files(
    path = here(data_dir),
    pattern = "\\d+_DeviceData\\.csv",
    full.names = TRUE
  )
  
  # Read and combine files with semicolon separation
  map_df(file_list, ~ {
    read_delim(.x, 
              delim = ";",
              col_types = cols(.default = col_character()),
              show_col_types = FALSE) %>% 
      type_convert()  # Automatically convert columns to appropriate types
  }) %>%
    arrange(Id)  # Proper numeric sorting
}


# Process with subject isolation
process_all_subjects <- function(raw_data) {
  raw_data %>%
    group_by(Id) %>%
    group_modify(~ {
      .x %>%
        clean_phase_luminosity() %>%
        split_eye_direction() %>%
        interpolate_blinking()
    }) %>%
    ungroup() %>%
    arrange(Id, ExperimentSecond)
}

# Import/process data
processed_device_combined <- import_subjects() %>% process_all_subjects()

```

## Modelling Pupil Size vs. Luminosity


```{r warning=FALSE, message=FALSE}
# Add normalized pupil size to the data, look at residuals
normalize_pupil_size <- function(data, model) {
  data <- data %>%
    mutate(
      AvgPupilSize = (LeftEyePupilSize + RightEyePupilSize) / 2,
      PredictedPupilSize = predict(model, newdata = data),
      ResidualPupilSize = AvgPupilSize - PredictedPupilSize
    )
  return(data)
}

# Normalized pupil size plotting
create_pupil_plot <- function(data, title, y_limits, luminosity_factor) {
  ggplot(data, aes(x = ExperimentSecond - ExperimentSecond[1])) +
      geom_smooth(aes(y = round((LeftEyePupilSize + RightEyePupilSize) / 2, 3), color = "Avg. Pupil Size"), se = FALSE, method = "loess", span = 0.012) +
    geom_line(aes(y = Luminosity * luminosity_factor, color = "Luminosity")) +
geom_smooth(aes(y = ResidualPupilSize, color = "Residual Pupil Size"), se = FALSE, method = "loess", span = 0.012) +
    scale_y_continuous(
      name = "Pupil Size (mm)",
      limits = y_limits,
      sec.axis = sec_axis(~ . / luminosity_factor, name = "Luminosity")
    ) +
    theme_minimal() +
    labs(
      title = title,
      x = "Time (seconds)",
      y = "Pupil Size (mm)",
      color = "Legend"
    ) +
    scale_color_manual(
      values = c(
        "Avg. Pupil Size" = "black",
        "Luminosity" = adjustcolor("green", alpha.f = 0.75),
        "Residual Pupil Size" = "blue"
      ),
      breaks = c("Avg. Pupil Size", "Luminosity", "Residual Pupil Size")
    )
}

# Define common y-axis limits
common_y_limits <- c(-2, 5)  # Adjust based on your data
luminosity_factor <- 14     # Scaling factor for Luminosity

# Filter data to only include experiment
filtered_data <- processed_device_combined %>%
  filter(
    VideoMode %in% c("Normal", "Hallucinations") &
    Phase == "Video"
  )

# Adding InverseLuminosity Column
filtered_data <- filtered_data %>%
  mutate(InverseLuminosity = 1 / Luminosity)

# Non-linear(generalized additive) model
model_gam <- gam((LeftEyePupilSize + RightEyePupilSize) / 2 ~ s(InverseLuminosity, k = 10), data = filtered_data)
data_gam <-normalize_pupil_size(filtered_data, model_gam)


id <- 5
# Create plots with residuals from non-linear (generalized additive) model
plot1 <- create_pupil_plot(
  data_gam %>% 
    filter(data_gam$Id == id, data_gam$VideoMode == "Normal", data_gam$VideoName == "Main_Mono_Normal_HighLayerStrong", data_gam$Phase == "Video"), "Normal Mono", id), common_y_limits, luminosity_factor)
plot2 <- create_pupil_plot(
  data_gam %>% 
    filter(data_gam$Id == id, data_gam$VideoMode == "Normal", data_gam$VideoName == "Main_Stereo_Normal_HighLayerStrong", data_gam$Phase == "Video"), "Normal Stereo", id), common_y_limits, luminosity_factor)
plot3 <- create_pupil_plot(
  data_gam %>% 
    filter(data_gam$Id == id, data_gam$VideoMode == "Hallucinations", data_gam$VideoName == "Main_Mono_Hallucinations_HighLayerStrong", data_gam$Phase == "Video"), "Hallucination Mono", common_y_limits, luminosity_factor)
plot4 <- create_pupil_plot(
  data_gam %>% 
    filter(data_gam$Id == id, data_gam$VideoMode == "Hallucinations", data_gam$VideoName == "Main_Stereo_Hallucinations_HighLayerStrong", data_gam$Phase == "Video"), "Hallucination Stereo", common_y_limits, luminosity_factor)

# Combine all plots into a 2x2 layout and display
p <- (plot1 + plot2) / (plot3 + plot4) +
  plot_layout(guides = "collect") + # Collect the legends into one
  plot_annotation(sprintf("Subject %s (Pre-Study) Pupil Size Normalized by Luminosity, Generalized Additive Model", id)) # Add a supertitle

print(p)
print(plot1)
print(plot2)
print(plot3)
print(plot4)

#summary(model)
#summary(model_gam)

summary(model_gam)
```
