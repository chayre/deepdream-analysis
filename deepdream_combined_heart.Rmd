---
title: "DeepDream - Subject 2 Physiological Analysis"
author:    |
    | Colin Ayres  
    | c.ayres@student.uw.edu.pl
date: "January 2025"
output: html_document
chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Import Packages

```{r warning=FALSE, message=FALSE}
# Load necessary packages
library(tidyverse)
library(here)
library(ggplot2)
library(zoo)
library(dplyr)
library(patchwork)
library(mgcv)
library(ggpubr)
library(rstatix)

# Set working directory
mds_dir <- here::here()

#dataecg <- read.csv("C:\\Users\\CAyre\\Documents\\Coding\\deepdream-analysis\\pre-study\\ECG\\ACQ\\ID01_baseline.csv", sep=";")

#dataecg
#unique(dataecg$EVENT)
#summary(dataecg)



#dataecg[dataecg$Heart.Rate==0,]

#file.exists("C:\\Users\\CAyre\\Documents\\Coding\\deepdream-analysis\\pre-study\\ECG\\ACQ\\ID01_baseline.csv")

```

## Defining Functions to Clean & Combine Data

```{r}
# Remove rows for which Heart Rate is 0
remove_zero_heart_rate <- function(data) {
  data %>% 
    filter(`Heart Rate` != 0)
}


```

## Load and Process All Subject Data

```{r warning=FALSE, message=FALSE}
# Import data
import_subjects_exp <- function(data_dir = "C:\\Users\\CAyre\\Documents\\Coding\\deepdream-analysis\\pre-study\\ECG\\ACQ") {
  # Get list of all subject files (e.g., ID01_baseline.csv, ID02_baseline.csv)
  file_list <- list.files(
    path = here(data_dir),
    pattern = "\\d+_experiment\\.csv",
    full.names = TRUE
  )

  # Read and combine all files
  data <- map_df(file_list, ~ {
    read_delim(.x, 
              delim = ";",
              col_types = cols(.default = col_character()),
              show_col_types = FALSE) %>%
      mutate(Id = as.integer(str_extract(basename(.x), "\\d+"))) %>%  # Extract ID
      type_convert()  # Automatically convert columns to appropriate types
  })

  # Arrange by subject ID
  data <- data %>% arrange(Id)

  return(data)
}


# Process with subject isolation
process_all_subjects <- function(raw_data) {
  raw_data %>%
    group_by(Id) %>%
    group_modify(~ {
      .x %>%
        remove_zero_heart_rate()
    }) %>%
    ungroup() %>%
    arrange(Id)
}

import_subjects_base <- function(data_dir = "C:\\Users\\CAyre\\Documents\\Coding\\deepdream-analysis\\pre-study\\ECG\\ACQ") {
  # Get list of all subject files (e.g., ID01_baseline.csv, ID02_baseline.csv)
  file_list <- list.files(
    path = here(data_dir),
    pattern = "ID\\d+_baseline\\.csv",
    full.names = TRUE
  )

  # Read and combine all files
  data <- map_df(file_list, ~ {
    read_delim(.x, 
              delim = ";",
              col_types = cols(.default = col_character()),
              show_col_types = FALSE) %>%
      mutate(Id = as.integer(str_extract(basename(.x), "\\d+"))) %>%  # Extract ID
      type_convert()  # Automatically convert columns to appropriate types
  })

  # Arrange by subject ID
  data <- data %>% arrange(Id)

  return(data)
}

# Execution
data_exp <- process_all_subjects(import_subjects_exp())
data_base <- process_all_subjects(import_subjects_base())

unique(nozero$Id)

# Import/process data
#processed_device_combined <- import_subjects() %>% process_all_subjects()

```

## ECG Statistical Testing Between Events

```{r}

calculate_sdnn <- function(rr_intervals) {
  sd(rr_intervals, na.rm = TRUE)
}

calculate_rmssd <- function(rr_intervals) {
  rr_diffs <- diff(rr_intervals)  # Compute successive differences
  sqrt(mean(rr_diffs^2, na.rm = TRUE))  # Root mean square
}

summarydata <- data_exp %>%
  group_by(Id, EVENT) %>%
  summarise(
    Mean_HR = mean(`Heart Rate`, na.rm = TRUE),  # Average Heart Rate
    HRV_SDNN = calculate_sdnn(`ECG R-R`),
    HRV_RMSSD = calculate_rmssd(`ECG R-R`)
  ) %>%
  ungroup()

summary(summarydata$HRV_SDNN)
summary(summarydata$HRV_RMSSD)

summarydata


# Function to compute Mean HR and HRV (SDNN) for subjects 1-14 in events 0, 1, or 2
compute_hr_hrv <- function(data) {
  data %>%
    filter(Id %in% 1:14, EVENT %in% c(0, 1, 2)) %>%
    group_by(Id, EVENT) %>%
    summarise(
      Mean_HR = mean(`Heart Rate`, na.rm = TRUE),
      HRV_SDNN = sd(`ECG R-R`, na.rm = TRUE),  # Standard deviation of RR intervals
      .groups = "drop"
    )
}

# Function to plot paired boxplots with p-values and connecting lines
plot_hr_hrv_paired <- function(hr_hrv_data) {
  plots <- list()
  
  # Define event pairs for comparison
  event_pairs <- list(c(0, 1), c(0, 2), c(1, 2))
  
  for (pair in event_pairs) {
    df_pair <- hr_hrv_data %>% 
      filter(EVENT %in% pair) %>%
      select(Id, EVENT, Mean_HR, HRV_SDNN) %>%
      pivot_wider(names_from = EVENT, values_from = c(Mean_HR, HRV_SDNN))  # Convert to wide format

    # Paired t-tests
    hr_test <- t.test(df_pair[[paste0("Mean_HR_", pair[1])]], 
                      df_pair[[paste0("Mean_HR_", pair[2])]], 
                      paired = TRUE, na.action = na.omit)

    hrv_test <- t.test(df_pair[[paste0("HRV_SDNN_", pair[1])]], 
                       df_pair[[paste0("HRV_SDNN_", pair[2])]], 
                       paired = TRUE, na.action = na.omit)

    # Convert back to long format for boxplots with connecting lines
    df_long <- hr_hrv_data %>% filter(EVENT %in% pair)

    # Boxplot for HR with connecting lines
    p_hr <- ggplot(df_long, aes(x = factor(EVENT), y = Mean_HR, fill = factor(EVENT))) +
      geom_boxplot(alpha = 0.6) +
      geom_line(aes(group = Id), color = "gray50", alpha = 0.5) +  # Add connecting lines
      geom_point(aes(color = "gray50"), alpha = 0.5, show.legend = FALSE) +  # Add points for clarity
      labs(title = paste("Heart Rate (HR): EVENT", pair[1], "vs.", pair[2]), 
           x = "EVENT", y = "Mean HR (bpm)") +
      theme_minimal() +
      annotate("text", x = 1.5, y = max(df_long$Mean_HR, na.rm = TRUE), 
               label = paste("p =", signif(hr_test$p.value, 3)), size = 5)

    # Boxplot for HRV with connecting lines
    p_hrv <- ggplot(df_long, aes(x = factor(EVENT), y = HRV_SDNN, fill = factor(EVENT))) +
      geom_boxplot(alpha = 0.6) +
      geom_line(aes(group = Id), color = "gray50", alpha = 0.5) +  # Add connecting lines
      geom_point(aes(color = "gray50"), alpha = 0.5, show.legend = FALSE) +  # Add points for clarity
      labs(title = paste("Heart Rate Variability (HRV): EVENT", pair[1], "vs.", pair[2]), 
           x = "EVENT", y = "HRV (SDNN, ms)") +
      theme_minimal() +
      annotate("text", x = 1.5, y = max(df_long$HRV_SDNN, na.rm = TRUE), 
               label = paste("p =", signif(hrv_test$p.value, 3)), size = 5)

    # Store plots
    plots[[paste0("HR_", pair[1], "_vs_", pair[2])]] <- p_hr
    plots[[paste0("HRV_", pair[1], "_vs_", pair[2])]] <- p_hrv
  }
  
  return(plots)
}


# Example Usage:
hr_hrv_data <- compute_hr_hrv(data_exp)  # Compute HR & HRV
t_test_results <- paired_t_test(hr_hrv_data)  # Run paired t-tests

# View results
t_test_results


# Example Usage:
paired_plots <- plot_hr_hrv_paired(hr_hrv_data)

# Display plots
print(paired_plots$HR_0_vs_1)
print(paired_plots$HR_0_vs_2)
print(paired_plots$HR_1_vs_2)

print(paired_plots$HRV_0_vs_1)
print(paired_plots$HRV_0_vs_2)
print(paired_plots$HRV_1_vs_2)

hr_hrv_data

unique(nozero$EVENT)

nozero$`ECG B, X, ECG2-R`


filtered_data <- nozero[nozero$Id == 3, ]
id_filtered <- filtered_data[filtered_data$EVENT == 4, ]


#summary(nozero$`ECG R-R`)
#table(nozero$`ECG R-R`)  # Check for unexpected 0 values



# Create the plot
ggplot(filtered_data, aes(x = seq_along(`ECG B, X, ECG2-R`), y = `ECG B, X, ECG2-R`)) +
  geom_line(color = "blue") +  # Plot ECG data
  #geom_point(color = "red", size = 1, alpha = 0.7) +  # Mark points

  # Add background shading for different EVENTS
  geom_rect(aes(xmin = seq_along(`ECG B, X, ECG2-R`), 
                xmax = seq_along(`ECG B, X, ECG2-R`), 
                ymin = -Inf, ymax = Inf, 
                fill = as.factor(EVENT)), 
            alpha = 0.1) +  # Transparency
  
  #scale_fill_manual(values = c("0" = "gray90", "1" = "lightblue", "2" = "lightgreen")) +  # Event colors
  labs(title = "ECG B, X, ECG2-R for Subject 1",
       x = "Index", 
       y = "ECG Signal",
       fill = "EVENT") +  
  theme_minimal()


event_counts <- data_exp %>%
  group_by(Id, EVENT) %>%
  summarise(Count = n(), .groups = "drop")

# Print table
print(event_counts)





# Filter data for Id = 1
subject_data <- data_exp %>% filter(Id == 1)

# Create the plot
ggplot(subject_data, aes(x = seq_along(EVENT), y = EVENT)) +
  geom_point(color = "red", size = 1, alpha = 0.7) +  # Add points

  labs(
    title = "EVENT by Frame for Id = 1",
    x = "Frame (Index)",
    y = "EVENT"
  ) +
  theme_minimal()

```
