---
title: "DeepDream - Subject 2 Physiological Analysis"
author:    |
    | Colin Ayres  
    | c.ayres@student.uw.edu.pl
date: "January 2025"
output: html_document
chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Import Packages

```{r warning=FALSE, message=FALSE}
# Load necessary packages
library(tidyverse)
library(here)
library(ggplot2)
library(zoo)
library(dplyr)
library(patchwork)
library(mgcv)
library(ggpubr)
library(rstatix)

# Set working directory
mds_dir <- here::here()

```

## Defining Functions to Clean & Combine Data

```{r}
# Remove rows for which Heart Rate is 0
remove_zero_heart_rate <- function(data) {
  data %>% 
    filter(`Heart Rate` != 0)
}

# Add Time column (1000 rows = 1 second)
add_time_column <- function(data) {
  data %>%
    group_by(Id) %>%
    mutate(Time = (row_number() - 1) / 1000) %>%  # Convert row number to seconds
    ungroup()
}

# Change 4 and 8 events which are repeated to 0 (i.e. If event column has 4, 4, 4 -> 4, 0, 0)
clean_repeated_events <- function(data) {
  data %>%
    arrange(Id, Time) %>%  # Ensure chronological order
    group_by(Id) %>%
    mutate(
      # Track time differences and event changes
      time_diff = Time - lag(Time, default = -Inf),
      event_changed = EVENT != lag(EVENT, default = first(EVENT)),
      
      # Identify new clusters of 4/8
      cluster = cumsum(
        (EVENT %in% c(4, 8) & (time_diff > 0.5 | event_changed)) |
          !(EVENT %in% c(4, 8))
      )
    ) %>%
    group_by(Id, cluster) %>%
    mutate(
      # Replace repeats with 0 within each cluster
      EVENT = ifelse(
        EVENT %in% c(4, 8) & row_number() > 1,
        0,
        EVENT
      )
    ) %>%
    ungroup() %>%
    select(-time_diff, -event_changed, -cluster)  # Remove helper columns
}
```

## Load and Process All Subject Data

```{r warning=FALSE, message=FALSE}
# Import data
import_subjects_exp <- function(data_dir = "C:\\Users\\CAyre\\Documents\\Coding\\deepdream-analysis\\pre-study\\ECG\\ACQ") {
  # Get list of all subject files (e.g., ID01_baseline.csv, ID02_baseline.csv)
  file_list <- list.files(
    path = here(data_dir),
    pattern = "\\d+_experiment\\.csv",
    full.names = TRUE
  )

  # Read and combine all files
  data <- map_df(file_list, ~ {
    read_delim(.x, 
              delim = ";",
              col_types = cols(.default = col_character()),
              show_col_types = FALSE) %>%
      mutate(Id = as.integer(str_extract(basename(.x), "\\d+"))) %>%  # Extract ID
      type_convert()  # Automatically convert columns to appropriate types
  })

  # Arrange by subject ID
  data <- data %>% arrange(Id)

  return(data)
}

import_subjects_base <- function(data_dir = "C:\\Users\\CAyre\\Documents\\Coding\\deepdream-analysis\\pre-study\\ECG\\ACQ") {
  # Get list of all subject files (e.g., ID01_baseline.csv, ID02_baseline.csv)
  file_list <- list.files(
    path = here(data_dir),
    pattern = "ID\\d+_baseline\\.csv",
    full.names = TRUE
  )

  # Read and combine all files
  data <- map_df(file_list, ~ {
    read_delim(.x, 
              delim = ";",
              col_types = cols(.default = col_character()),
              show_col_types = FALSE) %>%
      mutate(Id = as.integer(str_extract(basename(.x), "\\d+"))) %>%  # Extract ID
      type_convert()  # Automatically convert columns to appropriate types
  })

  # Arrange by subject ID
  data <- data %>% arrange(Id)

  return(data)
}

process_all_subjects <- function(raw_data) {
  # Clean column names
  raw_data <- raw_data %>%
    #rename_all(~str_trim(.) %>% make.names()) %>%  # Force valid column names
    rename(Id = matches("^id$", ignore.case = TRUE)) %>%  # Explicitly rename ID column
    mutate(Id = as.integer(Id))
  
  # Verify Id column exists
  if (!"Id" %in% colnames(raw_data)) {
    stop("Id column still missing after renaming. Columns found: ",
         paste(colnames(raw_data), collapse = ", "))
  }
  
  # Process using split-apply-combine
  raw_data %>%
    split(.$Id) %>%  # Base R splitting by Id
    map_dfr(~ {
      .x %>%
        add_time_column() %>%
        remove_zero_heart_rate() %>%
        clean_repeated_events() %>%
        mutate(Id = first(Id))  # Explicitly maintain Id column
    }) %>%
    arrange(Id)
}


# Execution
data_exp <- import_subjects_exp()
data_base <- import_subjects_base()

data_exp_processed <- process_all_subjects(data_exp)
data_base_processed <- process_all_subjects(data_base)


```

## ECG Statistical Testing Between Events

```{r}

calculate_sdnn <- function(rr_intervals) {
  sd(rr_intervals, na.rm = TRUE)
}

calculate_rmssd <- function(rr_intervals) {
  rr_diffs <- diff(rr_intervals)  # Compute successive differences
  sqrt(mean(rr_diffs^2, na.rm = TRUE))  # Root mean square
}

summarydata <- data_exp %>%
  group_by(Id, EVENT) %>%
  summarise(
    Mean_HR = mean(`Heart Rate`, na.rm = TRUE),  # Average Heart Rate
    HRV_SDNN = calculate_sdnn(`ECG R-R`),
    HRV_RMSSD = calculate_rmssd(`ECG R-R`)
  ) %>%
  ungroup()

summary(summarydata$HRV_SDNN)
summary(summarydata$HRV_RMSSD)

summarydata


# Function to compute Mean HR and HRV (SDNN) for subjects 1-14 in events 0, 1, or 2
compute_hr_hrv <- function(data) {
  data %>%
    filter(Id %in% 1:14, EVENT %in% c(0, 1, 2)) %>%
    group_by(Id, EVENT) %>%
    summarise(
      Mean_HR = mean(`Heart Rate`, na.rm = TRUE),
      HRV_SDNN = sd(`ECG R-R`, na.rm = TRUE),  # Standard deviation of RR intervals
      .groups = "drop"
    )
}

# Function to plot paired boxplots with p-values and connecting lines
plot_hr_hrv_paired <- function(hr_hrv_data) {
  plots <- list()
  
  # Define event pairs for comparison
  event_pairs <- list(c(0, 1), c(0, 2), c(1, 2))
  
  for (pair in event_pairs) {
    df_pair <- hr_hrv_data %>% 
      filter(EVENT %in% pair) %>%
      select(Id, EVENT, Mean_HR, HRV_SDNN) %>%
      pivot_wider(names_from = EVENT, values_from = c(Mean_HR, HRV_SDNN))  # Convert to wide format

    # Paired t-tests
    hr_test <- t.test(df_pair[[paste0("Mean_HR_", pair[1])]], 
                      df_pair[[paste0("Mean_HR_", pair[2])]], 
                      paired = TRUE, na.action = na.omit)

    hrv_test <- t.test(df_pair[[paste0("HRV_SDNN_", pair[1])]], 
                       df_pair[[paste0("HRV_SDNN_", pair[2])]], 
                       paired = TRUE, na.action = na.omit)

    # Convert back to long format for boxplots with connecting lines
    df_long <- hr_hrv_data %>% filter(EVENT %in% pair)

    # Boxplot for HR with connecting lines
    p_hr <- ggplot(df_long, aes(x = factor(EVENT), y = Mean_HR, fill = factor(EVENT))) +
      geom_boxplot(alpha = 0.6) +
      geom_line(aes(group = Id), color = "gray50", alpha = 0.5) +  # Add connecting lines
      geom_point(aes(color = "gray50"), alpha = 0.5, show.legend = FALSE) +  # Add points for clarity
      labs(title = paste("Heart Rate (HR): EVENT", pair[1], "vs.", pair[2]), 
           x = "EVENT", y = "Mean HR (bpm)") +
      theme_minimal() +
      annotate("text", x = 1.5, y = max(df_long$Mean_HR, na.rm = TRUE), 
               label = paste("p =", signif(hr_test$p.value, 3)), size = 5)

    # Boxplot for HRV with connecting lines
    p_hrv <- ggplot(df_long, aes(x = factor(EVENT), y = HRV_SDNN, fill = factor(EVENT))) +
      geom_boxplot(alpha = 0.6) +
      geom_line(aes(group = Id), color = "gray50", alpha = 0.5) +  # Add connecting lines
      geom_point(aes(color = "gray50"), alpha = 0.5, show.legend = FALSE) +  # Add points for clarity
      labs(title = paste("Heart Rate Variability (HRV): EVENT", pair[1], "vs.", pair[2]), 
           x = "EVENT", y = "HRV (SDNN, ms)") +
      theme_minimal() +
      annotate("text", x = 1.5, y = max(df_long$HRV_SDNN, na.rm = TRUE), 
               label = paste("p =", signif(hrv_test$p.value, 3)), size = 5)

    # Store plots
    plots[[paste0("HR_", pair[1], "_vs_", pair[2])]] <- p_hr
    plots[[paste0("HRV_", pair[1], "_vs_", pair[2])]] <- p_hrv
  }
  
  return(plots)
}


# Example Usage:
#hr_hrv_data <- compute_hr_hrv(data_exp)  # Compute HR & HRV
#t_test_results <- paired_t_test(hr_hrv_data)  # Run paired t-tests

# View results
#t_test_results


# Example Usage:
#paired_plots <- plot_hr_hrv_paired(hr_hrv_data)

# Display plots
#print(paired_plots$HR_0_vs_1)
#print(paired_plots$HR_0_vs_2)
#print(paired_plots$HR_1_vs_2)

#print(paired_plots$HRV_0_vs_1)
#print(paired_plots$HRV_0_vs_2)
#print(paired_plots$HRV_1_vs_2)

#hr_hrv_data

#unique(nozero$EVENT)

#nozero$`ECG B, X, ECG2-R`


#filtered_data <- nozero[nozero$Id == 3, ]
#id_filtered <- filtered_data[filtered_data$EVENT == 4, ]


#summary(nozero$`ECG R-R`)
#table(nozero$`ECG R-R`)  # Check for unexpected 0 values



# Create the plot
ggplot(filtered_data, aes(x = seq_along(`ECG B, X, ECG2-R`), y = `ECG B, X, ECG2-R`)) +
  geom_line(color = "blue") +  # Plot ECG data
  #geom_point(color = "red", size = 1, alpha = 0.7) +  # Mark points

  # Add background shading for different EVENTS
  geom_rect(aes(xmin = seq_along(`ECG B, X, ECG2-R`), 
                xmax = seq_along(`ECG B, X, ECG2-R`), 
                ymin = -Inf, ymax = Inf, 
                fill = as.factor(EVENT)), 
            alpha = 0.1) +  # Transparency
  
  #scale_fill_manual(values = c("0" = "gray90", "1" = "lightblue", "2" = "lightgreen")) +  # Event colors
  labs(title = "ECG B, X, ECG2-R for Subject 1",
       x = "Index", 
       y = "ECG Signal",
       fill = "EVENT") +  
  theme_minimal()


event_counts <- data_exp %>%
  group_by(Id, EVENT) %>%
  summarise(Count = n(), .groups = "drop")

# Print table
print(event_counts)





plot_event_by_frame <- function(subject_id, data = data_exp_processed) {
  # Filter data for the given Id and remove EVENT = 0
  subject_data <- data %>% 
    filter(Id == subject_id, EVENT != 0)
  
  # Create the plot
  ggplot(subject_data, aes(x = seq_along(EVENT), y = EVENT)) +
    geom_point(color = "red", size = 1, alpha = 0.7) +  # Add points
    labs(
      title = paste("EVENT by Frame for Id =", subject_id),
      x = "Frame (Index)",
      y = "EVENT"
    ) +
    theme_minimal()
}

# Execution
map(1:14, plot_event_by_frame)  # Loop through Ids 1-14



```

## Looking Between Events 4 and 8 for Experimental Data

```{r}
# In the experimental data, Subject 2, there is a random event 4 at the start of the data which does not correlate to an event 8 (the next event 8 happens ~1000 seconds later). I'm filtering this out.
data_exp_processed <- data_exp_processed %>%
  mutate(
    EVENT = if_else(
      Id == 2 & Time == 1.531,  # Match time with tolerance for precision
      0,  # Replace EVENT with 0
      EVENT  # Keep original value otherwise
    )
  )

# Select only points between events 4 and 8
filter_between_events <- function(data, start_event = 4, end_event = 8) {
  data %>%
    group_by(Id) %>%
    mutate(
      start_flag = EVENT == start_event,  # Mark start points
      end_flag = EVENT == end_event       # Mark end points
    ) %>%
    mutate(
      section_id = cumsum(start_flag),  # Track sections where EVENT == 4 starts
      valid_section = section_id > lag(cumsum(end_flag), default = 0)  # Ensure pairing
    ) %>%
    filter(valid_section) %>%
    select(-start_flag, -end_flag, -valid_section) %>%
    ungroup()
}

# Calculating Mean Heart Rate and Heart Rate Variability in each section (between Event = 4 and Event = 8) for each subject
results <- filtered_exp %>%
  filter(Id %in% 1:14, section_id %in% 1:4) %>%
  # Arrange by time within each subject-section group
  group_by(Id, section_id) %>%
  arrange(Time) %>%  
  summarise(
    # Calculate mean heart rate
    mean_heart_rate = mean(`Heart Rate`, na.rm = TRUE),
    
    # Calculate RMSSD for heart rate variability
    heart_rate_variability = ifelse(
      sum(!is.na(`ECG R-R`)) >= 2,  # Need at least 2 valid R-R intervals
      sqrt(mean(diff(`ECG R-R`)^2, na.rm = TRUE)),  # RMSSD formula
      NA_real_
    ),
    .groups = "drop"
  ) %>%
  # Clean up missing values
  mutate(
    mean_heart_rate = ifelse(is.nan(mean_heart_rate), NA, mean_heart_rate)
  )
# View results sorted by Id and section
results %>% arrange(Id, section_id)

filtered_exp <- filter_between_events(data_exp_processed)

# Uncomment below to see the 4 & 8 events picked out for a given subject Id
#data_event <- data_exp_processed %>%
#  filter(Id == 2 & EVENT %in% c(4, 8)) 
#data_event

```

## Paired T-Test for Mean Heart Rate
```{r}
run_all_paired_ttests <- function(data) {
  # Check required columns exist
  required_cols <- c("Id", "section_id", "mean_heart_rate")
  if (!all(required_cols %in% colnames(data))) {
    stop("Input data must contain columns: ", paste(required_cols, collapse = ", "))
  }
  
  # Get unique sections and create all possible pairs
  sections <- sort(unique(data$section_id))
  pairs <- as.data.frame(t(combn(sections, 2))) %>%
    setNames(c("section1", "section2"))
  
  # Process each pair
  results <- purrr::map_df(1:nrow(pairs), function(i) {
    pair <- pairs[i, ]
    
    # Prepare paired data
    paired_data <- data %>%
      filter(section_id %in% c(pair$section1, pair$section2)) %>%
      pivot_wider(
        id_cols = Id,
        names_from = section_id,
        values_from = mean_heart_rate,
        names_prefix = "section_"
      ) %>%
      na.omit()
    
    # Skip if insufficient data
    if (nrow(paired_data) < 2) {
      return(tibble(
        comparison = paste(pair$section1, "vs", pair$section2),
        message = "Insufficient data (n < 2)"
      ))
    }
    
    # Perform t-test
    t.test(
      paired_data[[paste0("section_", pair$section1)]],
      paired_data[[paste0("section_", pair$section2)]],
      paired = TRUE
    ) %>%
      broom::tidy() %>%
      mutate(
        comparison = paste(pair$section1, "vs", pair$section2),
        n_pairs = nrow(paired_data),
        .before = 1
      )
  })
  
  return(results)
}

# Execute
ttest_all_results <- run_all_paired_ttests(results)
print(ttest_all_results)

```
## Paired T-test for HRV

```{r}


```
